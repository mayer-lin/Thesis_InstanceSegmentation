<html>
<head>
<title>Segmentation_submitted.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Segmentation_submitted.py</font>
</center></td></tr></table>
<pre><span class="s0">#########################################################################################################</span>
<span class="s0">###### Using optimized hyperparameters, this script applies watershed / morpholigical segmentation ######</span>
<span class="s0">#########################################################################################################</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">rasterio</span>
<span class="s2">import </span><span class="s1">geopandas </span><span class="s2">as </span><span class="s1">gpd</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">ndimage </span><span class="s2">as </span><span class="s1">ndi</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">optimize </span><span class="s2">import </span><span class="s1">linear_sum_assignment</span>
<span class="s2">from </span><span class="s1">skimage </span><span class="s2">import </span><span class="s1">filters</span><span class="s3">, </span><span class="s1">morphology</span>
<span class="s2">from </span><span class="s1">skimage</span><span class="s3">.</span><span class="s1">filters </span><span class="s2">import </span><span class="s1">sobel</span>
<span class="s2">from </span><span class="s1">skimage</span><span class="s3">.</span><span class="s1">feature </span><span class="s2">import </span><span class="s1">peak_local_max</span>
<span class="s2">from </span><span class="s1">skimage</span><span class="s3">.</span><span class="s1">segmentation </span><span class="s2">import </span><span class="s1">watershed</span>
<span class="s2">from </span><span class="s1">skimage</span><span class="s3">.</span><span class="s1">morphology </span><span class="s2">import </span><span class="s1">disk</span><span class="s3">, </span><span class="s1">dilation</span><span class="s3">, </span><span class="s1">h_minima</span>
<span class="s2">from </span><span class="s1">skimage</span><span class="s3">.</span><span class="s1">measure </span><span class="s2">import </span><span class="s1">regionprops</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics </span><span class="s2">import </span><span class="s1">pairwise_distances</span>
<span class="s2">import </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>

<span class="s0"># Set Directories</span>
<span class="s1">raster_dir </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s4">&quot;data/input&quot;</span><span class="s3">)</span>
<span class="s1">ground_truth_dir </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s4">&quot;data/input&quot;</span><span class="s3">)</span>
<span class="s1">results_dir </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s4">&quot;data/input&quot;</span><span class="s3">)</span>
<span class="s1">fig_dir </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s4">&quot;data/results&quot;</span><span class="s3">)</span>
<span class="s1">results_dir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">parents</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s1">fig_dir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">parents</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

<span class="s0"># Define batch files. Adjust as needed. GT centroids were calculated in QGIS.</span>
<span class="s1">batch_files </span><span class="s3">= [</span>
    <span class="s3">(</span><span class="s1">raster_dir </span><span class="s3">/ </span><span class="s4">f&quot;selectclumps_batch</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">.tif&quot;</span><span class="s3">, </span><span class="s1">ground_truth_dir </span><span class="s3">/ </span><span class="s4">f&quot;centroid_batch</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">.shp&quot;</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
<span class="s3">]</span>

<span class="s0"># Prepare raster data. Downscale as needed.</span>
<span class="s2">def </span><span class="s1">load_raster</span><span class="s3">(</span><span class="s1">raster_path</span><span class="s3">, </span><span class="s1">downscale_factor</span><span class="s3">=</span><span class="s5">0</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">rasterio</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">raster_path</span><span class="s3">) </span><span class="s2">as </span><span class="s1">src</span><span class="s3">:</span>
        <span class="s1">nodata </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">nodata</span>
        <span class="s1">new_h </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">height </span><span class="s3">// </span><span class="s1">downscale_factor </span><span class="s2">if </span><span class="s1">downscale_factor </span><span class="s2">else </span><span class="s1">src</span><span class="s3">.</span><span class="s1">height</span>
        <span class="s1">new_w </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">width </span><span class="s3">// </span><span class="s1">downscale_factor </span><span class="s2">if </span><span class="s1">downscale_factor </span><span class="s2">else </span><span class="s1">src</span><span class="s3">.</span><span class="s1">width</span>
        <span class="s1">transform </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">transform </span><span class="s3">* </span><span class="s1">src</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">src</span><span class="s3">.</span><span class="s1">width </span><span class="s3">/ </span><span class="s1">new_w</span><span class="s3">, </span><span class="s1">src</span><span class="s3">.</span><span class="s1">height </span><span class="s3">/ </span><span class="s1">new_h</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span>
            <span class="s5">1</span><span class="s3">,</span>
            <span class="s1">out_shape</span><span class="s3">=(</span><span class="s1">new_h</span><span class="s3">, </span><span class="s1">new_w</span><span class="s3">),</span>
            <span class="s1">resampling</span><span class="s3">=</span><span class="s1">rasterio</span><span class="s3">.</span><span class="s1">enums</span><span class="s3">.</span><span class="s1">Resampling</span><span class="s3">.</span><span class="s1">average</span>
        <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">data</span><span class="s3">, </span><span class="s1">transform</span><span class="s3">, </span><span class="s1">nodata</span>

<span class="s0"># Prepare ground truth centroids.</span>
<span class="s2">def </span><span class="s1">load_ground_truth</span><span class="s3">(</span><span class="s1">shapefile</span><span class="s3">, </span><span class="s1">reference_raster</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">shapefile</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">() </span><span class="s2">or not </span><span class="s1">reference_raster</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">():</span>
        <span class="s2">return None</span>
    <span class="s2">with </span><span class="s1">rasterio</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">reference_raster</span><span class="s3">) </span><span class="s2">as </span><span class="s1">src</span><span class="s3">:</span>
        <span class="s1">crs </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">crs</span>
    <span class="s1">gdf </span><span class="s3">= </span><span class="s1">gpd</span><span class="s3">.</span><span class="s1">read_file</span><span class="s3">(</span><span class="s1">shapefile</span><span class="s3">).</span><span class="s1">to_crs</span><span class="s3">(</span><span class="s1">crs</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">y</span><span class="s3">) </span><span class="s2">for </span><span class="s1">pt </span><span class="s2">in </span><span class="s1">gdf</span><span class="s3">.</span><span class="s1">geometry </span><span class="s2">if </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">geom_type </span><span class="s3">== </span><span class="s4">&quot;Point&quot;</span><span class="s3">])</span>

<span class="s0"># Apply segmentation</span>
<span class="s2">def </span><span class="s1">apply_segmentation</span><span class="s3">(</span><span class="s1">raster_path</span><span class="s3">,</span><span class="s1">gamma</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">,</span><span class="s1">threshold_type</span><span class="s3">,</span><span class="s1">erosion_disk</span><span class="s3">,</span><span class="s1">dilation_disk</span><span class="s3">,</span><span class="s1">min_dist_frac</span><span class="s3">,</span><span class="s1">h_minima_frac</span><span class="s3">):</span>
    <span class="s1">elevation</span><span class="s3">, </span><span class="s1">transform</span><span class="s3">, </span><span class="s1">nodata </span><span class="s3">= </span><span class="s1">load_raster</span><span class="s3">(</span><span class="s1">raster_path</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">nodata </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">elevation </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">elevation </span><span class="s3">== </span><span class="s1">nodata</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">elevation</span><span class="s3">)</span>
    <span class="s1">elevation </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan_to_num</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">, </span><span class="s1">nan</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nanmin</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">))</span>
    <span class="s1">elevation </span><span class="s3">= (</span><span class="s1">elevation </span><span class="s3">- </span><span class="s1">elevation</span><span class="s3">.</span><span class="s1">min</span><span class="s3">()) / (</span><span class="s1">elevation</span><span class="s3">.</span><span class="s1">max</span><span class="s3">() - </span><span class="s1">elevation</span><span class="s3">.</span><span class="s1">min</span><span class="s3">())</span>
    <span class="s1">elevation </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">)</span>
    <span class="s1">elevation </span><span class="s3">= </span><span class="s1">ndi</span><span class="s3">.</span><span class="s1">gaussian_filter</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">=</span><span class="s1">sigma</span><span class="s3">)</span>
    <span class="s1">gradient </span><span class="s3">= </span><span class="s1">sobel</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">)</span>
    <span class="s1">thresh </span><span class="s3">= (</span>
        <span class="s1">filters</span><span class="s3">.</span><span class="s1">threshold_otsu</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">threshold_type </span><span class="s3">== </span><span class="s4">&quot;otsu&quot;</span>
        <span class="s2">else </span><span class="s1">filters</span><span class="s3">.</span><span class="s1">threshold_li</span><span class="s3">(</span><span class="s1">elevation</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">binary </span><span class="s3">= </span><span class="s1">elevation </span><span class="s3">&gt; </span><span class="s1">thresh</span>
    <span class="s1">binary </span><span class="s3">= </span><span class="s1">morphology</span><span class="s3">.</span><span class="s1">erosion</span><span class="s3">(</span><span class="s1">binary</span><span class="s3">, </span><span class="s1">disk</span><span class="s3">(</span><span class="s1">erosion_disk</span><span class="s3">))</span>
    <span class="s1">distance </span><span class="s3">= </span><span class="s1">ndi</span><span class="s3">.</span><span class="s1">distance_transform_edt</span><span class="s3">(</span><span class="s1">binary </span><span class="s3">* </span><span class="s1">gradient</span><span class="s3">)</span>
    <span class="s1">min_dist </span><span class="s3">= </span><span class="s1">min_dist_frac </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">distance</span><span class="s3">)</span>
    <span class="s1">peaks </span><span class="s3">= </span><span class="s1">peak_local_max</span><span class="s3">(</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">footprint</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)), </span><span class="s1">labels</span><span class="s3">=</span><span class="s1">binary</span><span class="s3">)</span>
    <span class="s1">filtered </span><span class="s3">= </span><span class="s1">peaks</span><span class="s3">[</span><span class="s1">distance</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">peaks</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)] &gt; </span><span class="s1">min_dist</span><span class="s3">]</span>
    <span class="s1">markers </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>
    <span class="s1">markers</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">filtered</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)] = </span><span class="s2">True</span>
    <span class="s1">markers </span><span class="s3">= </span><span class="s1">dilation</span><span class="s3">(</span><span class="s1">markers</span><span class="s3">, </span><span class="s1">disk</span><span class="s3">(</span><span class="s1">dilation_disk</span><span class="s3">))</span>
    <span class="s1">markers</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">ndi</span><span class="s3">.</span><span class="s1">label</span><span class="s3">(</span><span class="s1">markers</span><span class="s3">)</span>
    <span class="s1">_ </span><span class="s3">= </span><span class="s1">watershed</span><span class="s3">(-</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">markers</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">binary</span><span class="s3">)</span>
    <span class="s1">h_min </span><span class="s3">= </span><span class="s1">h_minima</span><span class="s3">(-</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">h_minima_frac </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">distance</span><span class="s3">))</span>
    <span class="s1">hwt_markers</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">ndi</span><span class="s3">.</span><span class="s1">label</span><span class="s3">(</span><span class="s1">h_min</span><span class="s3">)</span>
    <span class="s1">labels_hwt </span><span class="s3">= </span><span class="s1">watershed</span><span class="s3">(-</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">hwt_markers</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">binary</span><span class="s3">)</span>
    <span class="s1">centroids </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">region</span><span class="s3">.</span><span class="s1">centroid </span><span class="s2">for </span><span class="s1">region </span><span class="s2">in </span><span class="s1">regionprops</span><span class="s3">(</span><span class="s1">labels_hwt</span><span class="s3">)])</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">rasterio</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">.</span><span class="s1">xy</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">y</span><span class="s3">, </span><span class="s1">x </span><span class="s2">in </span><span class="s1">centroids</span><span class="s3">])</span>

<span class="s0"># Use the Hungarian algorithm to match detected Centroids. Adjust buffer as needed.</span>
<span class="s2">def </span><span class="s1">compute_global_iou</span><span class="s3">(</span><span class="s1">gt_centroids_list</span><span class="s3">, </span><span class="s1">detected_centroids_list</span><span class="s3">, </span><span class="s1">transform</span><span class="s3">, </span><span class="s1">buffer_radius</span><span class="s3">=</span><span class="s5">49</span><span class="s3">):</span>
    <span class="s1">all_gt_world </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span><span class="s1">gt_centroids_list</span><span class="s3">) </span><span class="s2">if </span><span class="s1">gt_centroids_list </span><span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">all_det_world </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span><span class="s1">detected_centroids_list</span><span class="s3">) </span><span class="s2">if </span><span class="s1">detected_centroids_list </span><span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">gt_count</span><span class="s3">, </span><span class="s1">det_count </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">all_gt_world</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">all_det_world</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">gt_count </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">det_count </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0.0</span><span class="s3">, </span><span class="s1">gt_count</span><span class="s3">, </span><span class="s1">det_count</span><span class="s3">, </span><span class="s5">0.0</span>

    <span class="s1">transform_inv </span><span class="s3">= ~</span><span class="s1">transform</span>
    <span class="s1">all_gt_px </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">transform_inv </span><span class="s3">* </span><span class="s1">pt </span><span class="s2">for </span><span class="s1">pt </span><span class="s2">in </span><span class="s1">all_gt_world</span><span class="s3">])</span>
    <span class="s1">all_det_px </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">transform_inv </span><span class="s3">* </span><span class="s1">pt </span><span class="s2">for </span><span class="s1">pt </span><span class="s2">in </span><span class="s1">all_det_world</span><span class="s3">])</span>

    <span class="s1">dist </span><span class="s3">= </span><span class="s1">pairwise_distances</span><span class="s3">(</span><span class="s1">all_gt_px</span><span class="s3">, </span><span class="s1">all_det_px</span><span class="s3">)</span>
    <span class="s1">row_ind</span><span class="s3">, </span><span class="s1">col_ind </span><span class="s3">= </span><span class="s1">linear_sum_assignment</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">)</span>
    <span class="s1">matched </span><span class="s3">= </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">[</span><span class="s1">r</span><span class="s3">, </span><span class="s1">c</span><span class="s3">] &lt; </span><span class="s1">buffer_radius </span><span class="s2">for </span><span class="s1">r</span><span class="s3">, </span><span class="s1">c </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">row_ind</span><span class="s3">, </span><span class="s1">col_ind</span><span class="s3">))</span>

    <span class="s1">union </span><span class="s3">= </span><span class="s1">gt_count </span><span class="s3">+ </span><span class="s1">det_count </span><span class="s3">- </span><span class="s1">matched</span>
    <span class="s1">iou </span><span class="s3">= </span><span class="s1">matched </span><span class="s3">/ </span><span class="s1">union </span><span class="s2">if </span><span class="s1">union </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">else </span><span class="s5">0.0</span>
    <span class="s2">if </span><span class="s1">det_count </span><span class="s3">&gt; </span><span class="s1">gt_count</span><span class="s3">:</span>
        <span class="s1">iou </span><span class="s3">*= (</span><span class="s1">gt_count </span><span class="s3">/ </span><span class="s1">det_count</span><span class="s3">)</span>
    <span class="s1">count_acc </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">gt_count </span><span class="s3">- </span><span class="s1">det_count</span><span class="s3">) / </span><span class="s1">max</span><span class="s3">(</span><span class="s1">gt_count</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
    <span class="s1">final_score </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">count_acc </span><span class="s3">+ </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">iou</span>
    <span class="s2">return </span><span class="s1">iou</span><span class="s3">, </span><span class="s1">gt_count</span><span class="s3">, </span><span class="s1">det_count</span><span class="s3">, </span><span class="s1">final_score</span>

<span class="s0"># Run segmentation &amp; evaluation with fixed parameters</span>
<span class="s2">def </span><span class="s1">run_with_params</span><span class="s3">(</span><span class="s1">params</span><span class="s3">, </span><span class="s1">enable_visuals</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
    <span class="s1">gamma </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;gamma&quot;</span><span class="s3">]</span>
    <span class="s1">sigma </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;sigma&quot;</span><span class="s3">]</span>
    <span class="s1">threshold_type </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;threshold_type&quot;</span><span class="s3">]</span>
    <span class="s1">erosion_disk </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;erosion_disk&quot;</span><span class="s3">]</span>
    <span class="s1">dilation_disk </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;dilation_disk&quot;</span><span class="s3">]</span>
    <span class="s1">min_dist_frac </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;min_distance_fraction&quot;</span><span class="s3">]</span>
    <span class="s1">h_minima_frac </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;h_minima_fraction&quot;</span><span class="s3">]</span>
    <span class="s1">buffer_radius </span><span class="s3">= </span><span class="s5">49</span>

    <span class="s1">batch_scores </span><span class="s3">= []</span>
    <span class="s1">batch_metrics </span><span class="s3">= []</span>

    <span class="s2">for </span><span class="s1">idx</span><span class="s3">, (</span><span class="s1">raster_path</span><span class="s3">, </span><span class="s1">gt_path</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">batch_files</span><span class="s3">):</span>
        <span class="s1">batch_id </span><span class="s3">= </span><span class="s1">idx </span><span class="s3">+ </span><span class="s5">1</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot; Processing batch </span><span class="s2">{</span><span class="s1">batch_id</span><span class="s2">}</span><span class="s4">:&quot;</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;    Raster exists: </span><span class="s2">{</span><span class="s1">raster_path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">()</span><span class="s2">} </span><span class="s4">| GT exists: </span><span class="s2">{</span><span class="s1">gt_path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">()</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">raster_path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">() </span><span class="s2">or not </span><span class="s1">gt_path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">():</span>
            <span class="s2">continue</span>

        <span class="s1">gt </span><span class="s3">= </span><span class="s1">load_ground_truth</span><span class="s3">(</span><span class="s1">gt_path</span><span class="s3">, </span><span class="s1">raster_path</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">gt </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;No valid ground truth for batch </span><span class="s2">{</span><span class="s1">batch_id</span><span class="s2">}</span><span class="s4">.&quot;</span><span class="s3">)</span>
            <span class="s2">continue</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;    # GT loaded: </span><span class="s2">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">gt</span><span class="s3">)</span><span class="s2">} </span><span class="s4">points&quot;</span><span class="s3">)</span>

        <span class="s1">elevation_map</span><span class="s3">, </span><span class="s1">transform_img</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">load_raster</span><span class="s3">(</span><span class="s1">raster_path</span><span class="s3">)</span>
        <span class="s1">det </span><span class="s3">= </span><span class="s1">apply_segmentation</span><span class="s3">(</span>
            <span class="s1">raster_path</span><span class="s3">,</span>
            <span class="s1">gamma</span><span class="s3">,</span>
            <span class="s1">sigma</span><span class="s3">,</span>
            <span class="s1">threshold_type</span><span class="s3">,</span>
            <span class="s1">erosion_disk</span><span class="s3">,</span>
            <span class="s1">dilation_disk</span><span class="s3">,</span>
            <span class="s1">min_dist_frac</span><span class="s3">,</span>
            <span class="s1">h_minima_frac</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">det </span><span class="s2">is None or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">det</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot; Batch </span><span class="s2">{</span><span class="s1">batch_id</span><span class="s2">}</span><span class="s4">: no detections.&quot;</span><span class="s3">)</span>
            <span class="s2">continue</span>

        <span class="s1">iou</span><span class="s3">, </span><span class="s1">gt_count</span><span class="s3">, </span><span class="s1">det_count</span><span class="s3">, </span><span class="s1">score </span><span class="s3">= </span><span class="s1">compute_global_iou</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">gt</span><span class="s3">], [</span><span class="s1">det</span><span class="s3">], </span><span class="s1">transform_img</span><span class="s3">, </span><span class="s1">buffer_radius</span>
        <span class="s3">)</span>
        <span class="s1">count_acc </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1 </span><span class="s3">- </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">gt_count </span><span class="s3">- </span><span class="s1">det_count</span><span class="s3">) / </span><span class="s1">max</span><span class="s3">(</span><span class="s1">gt_count</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;      Batch </span><span class="s2">{</span><span class="s1">batch_id</span><span class="s2">} </span><span class="s4">— IoU: </span><span class="s2">{</span><span class="s1">iou</span><span class="s2">:</span><span class="s4">.3f</span><span class="s2">}</span><span class="s4">, Count Acc: </span><span class="s2">{</span><span class="s1">count_acc</span><span class="s2">:</span><span class="s4">.3f</span><span class="s2">}</span><span class="s4">, Score: </span><span class="s2">{</span><span class="s1">score</span><span class="s2">:</span><span class="s4">.3f</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">transform_inv </span><span class="s3">= ~</span><span class="s1">transform_img</span>
        <span class="s1">gt_px </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">transform_inv </span><span class="s3">* </span><span class="s1">pt </span><span class="s2">for </span><span class="s1">pt </span><span class="s2">in </span><span class="s1">gt</span><span class="s3">])</span>
        <span class="s1">det_px </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">transform_inv </span><span class="s3">* </span><span class="s1">pt </span><span class="s2">for </span><span class="s1">pt </span><span class="s2">in </span><span class="s1">det</span><span class="s3">])</span>
        <span class="s1">dist_matrix </span><span class="s3">= </span><span class="s1">pairwise_distances</span><span class="s3">(</span><span class="s1">gt_px</span><span class="s3">, </span><span class="s1">det_px</span><span class="s3">)</span>
        <span class="s1">row_ind</span><span class="s3">, </span><span class="s1">col_ind </span><span class="s3">= </span><span class="s1">linear_sum_assignment</span><span class="s3">(</span><span class="s1">dist_matrix</span><span class="s3">)</span>
        <span class="s1">matched_pairs </span><span class="s3">= [</span>
            <span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">r</span><span class="s3">, </span><span class="s1">c </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">row_ind</span><span class="s3">, </span><span class="s1">col_ind</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">dist_matrix</span><span class="s3">[</span><span class="s1">r</span><span class="s3">, </span><span class="s1">c</span><span class="s3">] &lt; </span><span class="s1">buffer_radius</span>
        <span class="s3">]</span>
        <span class="s1">matched </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">matched_pairs</span><span class="s3">)</span>
        <span class="s1">matched_gt </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">r </span><span class="s2">for </span><span class="s1">r</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">matched_pairs</span><span class="s3">)</span>
        <span class="s1">matched_det </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">c </span><span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">c </span><span class="s2">in </span><span class="s1">matched_pairs</span><span class="s3">)</span>
        <span class="s1">missed_gt </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">gt</span><span class="s3">) - </span><span class="s1">len</span><span class="s3">(</span><span class="s1">matched_gt</span><span class="s3">)</span>
        <span class="s1">extra_det </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">det</span><span class="s3">) - </span><span class="s1">len</span><span class="s3">(</span><span class="s1">matched_det</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;      Matched: </span><span class="s2">{</span><span class="s1">matched</span><span class="s2">}</span><span class="s4">, Missed GT: </span><span class="s2">{</span><span class="s1">missed_gt</span><span class="s2">}</span><span class="s4">, Extra Det: </span><span class="s2">{</span><span class="s1">extra_det</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">batch_scores</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">score</span><span class="s3">)</span>
        <span class="s1">batch_metrics</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span>
            <span class="s4">&quot;batch&quot;</span><span class="s3">: </span><span class="s1">batch_id</span><span class="s3">,</span>
            <span class="s4">&quot;iou&quot;</span><span class="s3">: </span><span class="s1">round</span><span class="s3">(</span><span class="s1">iou</span><span class="s3">, </span><span class="s5">3</span><span class="s3">),</span>
            <span class="s4">&quot;count_accuracy&quot;</span><span class="s3">: </span><span class="s1">round</span><span class="s3">(</span><span class="s1">count_acc</span><span class="s3">, </span><span class="s5">3</span><span class="s3">),</span>
            <span class="s4">&quot;gt_count&quot;</span><span class="s3">: </span><span class="s1">gt_count</span><span class="s3">,</span>
            <span class="s4">&quot;detected_count&quot;</span><span class="s3">: </span><span class="s1">det_count</span><span class="s3">,</span>
            <span class="s4">&quot;matched&quot;</span><span class="s3">: </span><span class="s1">matched</span><span class="s3">,</span>
            <span class="s4">&quot;missed_gt&quot;</span><span class="s3">: </span><span class="s1">missed_gt</span><span class="s3">,</span>
            <span class="s4">&quot;extra_detected&quot;</span><span class="s3">: </span><span class="s1">extra_det</span><span class="s3">,</span>
            <span class="s4">&quot;score&quot;</span><span class="s3">: </span><span class="s1">round</span><span class="s3">(</span><span class="s1">score</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s3">})</span>

    <span class="s1">final_score </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">batch_scores</span><span class="s3">) </span><span class="s2">if </span><span class="s1">batch_scores </span><span class="s2">else </span><span class="s5">0.0</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">\n </span><span class="s4">Overall Final Score: </span><span class="s2">{</span><span class="s1">final_score</span><span class="s2">:</span><span class="s4">.3f</span><span class="s2">}\n</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">enable_visuals </span><span class="s2">and </span><span class="s1">batch_metrics</span><span class="s3">:</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">batch_metrics</span><span class="s3">)</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;site&quot;</span><span class="s3">] = </span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;batch&quot;</span><span class="s3">].</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">&quot;Stet 1&quot; </span><span class="s2">if </span><span class="s1">x </span><span class="s3">&lt;= </span><span class="s5">20 </span><span class="s2">else </span><span class="s4">&quot;Jona 1&quot;</span><span class="s3">) </span><span class="s0"># Adjust this according to your site batch numbers</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_csv</span><span class="s3">(</span><span class="s1">results_dir </span><span class="s3">/ </span><span class="s4">&quot;segmentation_summary.csv&quot;</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s0"># rename as needed</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;Saved summary to </span><span class="s2">{</span><span class="s1">results_dir </span><span class="s3">/ </span><span class="s4">'segmentation_summary.csv'</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">) </span><span class="s0"># rename as needed</span>

        <span class="s0"># Observed vs Predicted Scatter</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">(</span><span class="s1">figsize</span><span class="s3">=(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">6</span><span class="s3">))</span>
        <span class="s1">stet_df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">[</span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;site&quot;</span><span class="s3">] == </span><span class="s4">&quot;Stet 1&quot;</span><span class="s3">]</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">scatter</span><span class="s3">(</span>
            <span class="s1">stet_df</span><span class="s3">[</span><span class="s4">&quot;gt_count&quot;</span><span class="s3">],</span>
            <span class="s1">stet_df</span><span class="s3">[</span><span class="s4">&quot;detected_count&quot;</span><span class="s3">],</span>
            <span class="s1">label</span><span class="s3">=</span><span class="s4">&quot;Stet 1&quot;</span><span class="s3">,</span>
            <span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.9</span><span class="s3">,</span>
            <span class="s1">edgecolors</span><span class="s3">=</span><span class="s4">'k'</span><span class="s3">,</span>
            <span class="s1">color</span><span class="s3">=</span><span class="s4">&quot;#fde725&quot;</span>
        <span class="s3">)</span>
        <span class="s1">jona_df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">[</span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;site&quot;</span><span class="s3">] == </span><span class="s4">&quot;Jona 1&quot;</span><span class="s3">]</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">scatter</span><span class="s3">(</span>
            <span class="s1">jona_df</span><span class="s3">[</span><span class="s4">&quot;gt_count&quot;</span><span class="s3">],</span>
            <span class="s1">jona_df</span><span class="s3">[</span><span class="s4">&quot;detected_count&quot;</span><span class="s3">],</span>
            <span class="s1">label</span><span class="s3">=</span><span class="s4">&quot;Jona 1&quot;</span><span class="s3">,</span>
            <span class="s1">alpha</span><span class="s3">=</span><span class="s5">0.9</span><span class="s3">,</span>
            <span class="s1">edgecolors</span><span class="s3">=</span><span class="s4">'k'</span><span class="s3">,</span>
            <span class="s1">color</span><span class="s3">=</span><span class="s4">&quot;#414487&quot;</span>
        <span class="s3">)</span>
        <span class="s1">max_val </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;gt_count&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">(), </span><span class="s1">df</span><span class="s3">[</span><span class="s4">&quot;detected_count&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">()) + </span><span class="s5">10</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">plot</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max_val</span><span class="s3">], </span><span class="s4">'grey'</span><span class="s3">, </span><span class="s1">linestyle</span><span class="s3">=</span><span class="s4">'--'</span><span class="s3">, </span><span class="s1">label</span><span class="s3">=</span><span class="s4">'1:1 Line'</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">xlabel</span><span class="s3">(</span><span class="s4">&quot;Ground Truth Count (Observed)&quot;</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">ylabel</span><span class="s3">(</span><span class="s4">&quot;Detected Count (Predicted)&quot;</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">title</span><span class="s3">(</span><span class="s4">&quot;Observed vs. Predicted Counts by Site&quot;</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">legend</span><span class="s3">()</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">grid</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">tight_layout</span><span class="s3">()</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">savefig</span><span class="s3">(</span><span class="s1">fig_dir </span><span class="s3">/ </span><span class="s4">&quot;observed_vs_predicted_scatter.png&quot;</span><span class="s3">) </span><span class="s0">#Rename as needed</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">show</span><span class="s3">()</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">return </span><span class="s1">final_score</span>

<span class="s0"># SET HYPERPARAMETERS HERE!! You can use the best performing hyperparameters from the optimization trial.</span>
<span class="s2">if </span><span class="s1">__name__ </span><span class="s3">== </span><span class="s4">&quot;__main__&quot;</span><span class="s3">:</span>
    <span class="s1">fixed_params </span><span class="s3">= {</span>
        <span class="s4">&quot;gamma&quot;</span><span class="s3">: </span><span class="s5">0.5168518310522704</span><span class="s3">,</span>
        <span class="s4">&quot;sigma&quot;</span><span class="s3">: </span><span class="s5">0.729704864886184</span><span class="s3">,</span>
        <span class="s4">&quot;threshold_type&quot;</span><span class="s3">: </span><span class="s4">&quot;otsu&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;erosion_disk&quot;</span><span class="s3">: </span><span class="s5">3</span><span class="s3">,</span>
        <span class="s4">&quot;dilation_disk&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">,</span>
        <span class="s4">&quot;min_distance_fraction&quot;</span><span class="s3">: </span><span class="s5">0.174633335416156</span><span class="s3">,</span>
        <span class="s4">&quot;h_minima_fraction&quot;</span><span class="s3">: </span><span class="s5">0.0914933448375912</span>
    <span class="s3">}</span>

    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot; Running segmentation on all batches with set hyperparameters...&quot;</span><span class="s3">)</span>
    <span class="s1">run_with_params</span><span class="s3">(</span><span class="s1">fixed_params</span><span class="s3">, </span><span class="s1">enable_visuals</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">summary_path </span><span class="s3">= </span><span class="s1">results_dir </span><span class="s3">/ </span><span class="s4">&quot;segmentation_summary.csv&quot; </span><span class="s0"># Rename as needed</span>
    <span class="s2">if </span><span class="s1">summary_path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">():</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n </span><span class="s4">Per-batch Results Summary:&quot;</span><span class="s3">)</span>
        <span class="s1">summary_df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">summary_path</span><span class="s3">)</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s1">summary_df</span><span class="s3">.</span><span class="s1">to_string</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;No per-batch summary CSV found.&quot;</span><span class="s3">)</span></pre>
</body>
</html>